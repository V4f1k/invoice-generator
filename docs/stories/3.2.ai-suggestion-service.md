# Story 3.2: AI Suggestion Service (Backend)

## Status
- Draft

## Story
**As a** developer,
**I want** a backend API endpoint that can generate suggestions based on a user's invoicing history,
**so that** the frontend has a fast and reliable service to power AI-driven features.

## Acceptance Criteria
1. A new, secure API endpoint is created (e.g., `/api/suggestions/invoice-items`).
2. When provided with a `customerId`, the endpoint returns a list of the most frequent line item descriptions previously invoiced to that specific customer.
3. The service is performant and returns a response in under 500ms.

## Tasks / Subtasks
- [ ] **Task 1: Implement Suggestion API Endpoint (AC: #1, #2, #3)**
  - [ ] Subtask 1.1: Create a `GET /api/v1/suggestions/invoice-items` endpoint, protected by authentication.
  - [ ] Subtask 1.2: The endpoint should accept a `customerId` as a required query parameter.
  - [ ] Subtask 1.3: Implement a database query that finds all `invoice_items` for invoices linked to the given `customerId` and the authenticated supplier.
  - [ ] Subtask 1.4: The query should group the items by `description`, count the occurrences, and order by the count in descending order.
  - [ ] Subtask 1.5: The endpoint should return a list of the top 3-5 most frequent item descriptions.
  - [ ] Subtask 1.6: Ensure the query is optimized for performance to meet the <500ms response time requirement.

## Dev Notes
- **i18n**: As a global project requirement, all new UI work must use the internationalization framework (see Story 4.1).
- This story is purely for the backend service. The frontend implementation that consumes this service will be handled in the next story.
- **Performance**: The query performance is important. Ensure appropriate database indexes are placed on `invoices(customer_id)` and `invoice_items(invoice_id)` to support this query efficiently.
- **Data Isolation**: The logic must only consider invoices for the currently authenticated supplier to maintain strict data isolation.

### Testing
- An integration test for the `/suggestions/invoice-items` endpoint is essential.
- The test should seed the database with a history of invoices and items for a specific customer and verify that the endpoint returns the correct descriptions in the correct order of frequency.
- Test edge cases, such as when a customer has no invoice history (should return an empty list) or when the `customerId` is invalid.
- The test must also verify that the endpoint enforces ownership and does not return suggestions for customers belonging to another supplier.

## Change Log
| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Initial draft              | Sarah  |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used

#### Debug Log References

#### Completion Notes List

#### File List

---
## QA Results
*(This section is to be filled out by the QA Agent after development)*

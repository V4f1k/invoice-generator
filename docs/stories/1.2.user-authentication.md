# Story 1.2: User Registration & Authentication

## Status
- Done

## Story
**As a** new user,
**I want** to register for an account using my email and a password and then log in,
**so that** I can securely access and manage my private invoicing data.

## Acceptance Criteria
1. A user can create a new account.
2. A user can log in with their credentials to receive a JWT access token.
3. API routes that require authentication are protected and return a `401 Unauthorized` error if no valid token is provided.
4. The frontend securely stores the token and uses it for subsequent API requests.

## Tasks / Subtasks
- [x] **Task 1: Create User Model and Database Table (AC: #1)**
  - [x] Subtask 1.1: Define the `users` table schema in the database (id, email, password_hash, timestamps).
  - [x] Subtask 1.2: Implement a database migration to create the table.
- [x] **Task 2: Implement Registration Endpoint (AC: #1)**
  - [x] Subtask 2.1: Create a `POST /api/v1/auth/register` endpoint.
  - [x] Subtask 2.2: Implement logic to hash the user's password (e.g., using `bcrypt`).
  - [x] Subtask 2.3: Save the new user to the database, ensuring email addresses are unique.
- [x] **Task 3: Implement Login Endpoint (AC: #2)**
  - [x] Subtask 3.1: Create a `POST /api/v1/auth/login` endpoint.
  - [x] Subtask 3.2: Implement logic to find the user by email and verify their password.
  - [x] Subtask 3.3: Generate a JWT upon successful authentication.
  - [x] Subtask 3.4: Return the JWT to the client in a secure, `HttpOnly` cookie.
- [x] **Task 4: Implement Authentication Middleware (AC: #3)**
  - [x] Subtask 4.1: Create a middleware for Express.js that checks for a valid JWT from the `HttpOnly` cookie.
  - [x] Subtask 4.2: Apply the middleware to all API routes that require authentication.
  - [x] Subtask 4.3: Ensure the middleware returns a 401 error if the token is missing or invalid.
- [x] **Task 5: Create Frontend Login/Registration UI (AC: #1, #4)**
  - [x] Subtask 5.1: Build the registration page/form component using React Hook Form and Zod.
  - [x] Subtask 5.2: Build the login page/form component.
  - [x] Subtask 5.3: Implement logic to call the `/register` and `/login` API endpoints.
- [x] **Task 6: Implement Frontend Session Management (AC: #4)**
  - [x] Subtask 6.1: Create a mechanism using Zustand to manage the user's authentication state globally.
  - [x] Subtask 6.2: Implement protected routes that redirect to the login page if the user is not authenticated.

## Dev Notes
- **MCP Workflow**: Per the architecture, all ShadCN components must be managed using the project's specific command: `npx shadcn@latest mcp`.
- This story implements the authentication flow detailed in the `architecture.md` document.
- **Security**: Passwords must be hashed using a strong algorithm like `bcrypt`. JWTs must be stored in `HttpOnly` cookies to prevent XSS.
- **Frontend**: The front-end spec calls for Zustand for simple global state, which is appropriate for managing the user's authentication status.

### Testing
- Unit tests are required for the password hashing utility.
- Integration tests are required for the `/register`, `/login`, and protected endpoints. Test for success cases, and error cases like duplicate emails or incorrect passwords.
- E2E tests should cover the entire user flow: visiting the site, being redirected to login, navigating to register, creating an account, and logging in successfully.

## Change Log
| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Initial draft              | Sarah  |
| 2025-08-29 | 1.1     | Implementation completed   | James  |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used
Claude 3.5 Sonnet (James - Dev Agent)

#### Debug Log References
- TypeScript void return type issues with Express handlers resolved
- Prisma PostgreSQL schema configured for user authentication
- Frontend/backend integration with cookie-based JWT authentication

#### Completion Notes List
- User model created with Prisma ORM using PostgreSQL
- Secure password hashing implemented with bcrypt (10 salt rounds)
- JWT authentication with HttpOnly cookies for security
- Registration endpoint with email validation and password strength requirements
- Login endpoint with credential verification
- Authentication middleware protecting API routes
- Frontend forms built with ShadCN components, React Hook Form and Zod validation
- Global authentication state management with Zustand with persist middleware
- Protected routes with automatic redirect to login
- Complete authentication flow: register → login → dashboard → logout
- ShadCN UI components for modern, accessible authentication forms

#### File List
**Backend Created:**
- `/apps/api/prisma/schema.prisma` - User model definition
- `/apps/api/.env.example` - Environment variables template
- `/apps/api/src/utils/auth.ts` - Authentication utilities (hashing, JWT)
- `/apps/api/src/utils/prisma.ts` - Prisma client configuration
- `/apps/api/src/routes/auth.ts` - Authentication endpoints
- `/apps/api/src/middleware/auth.ts` - JWT authentication middleware
- `/apps/api/src/types/express.d.ts` - Express type extensions
- `/apps/api/src/__tests__/auth.test.ts` - Authentication integration tests
- `/apps/api/src/__tests__/utils/auth.test.ts` - Auth utilities unit tests
- `/apps/api/.env.test` - Test environment configuration

**Frontend Created:**
- `/apps/web/app/lib/auth-store.ts` - Zustand authentication store with persist
- `/apps/web/app/lib/api.ts` - API client configuration
- `/apps/web/app/lib/schemas.ts` - Zod validation schemas
- `/apps/web/app/components/auth/LoginForm.tsx` - ShadCN-based login form component
- `/apps/web/app/components/auth/RegisterForm.tsx` - ShadCN-based registration form component
- `/apps/web/app/components/ProtectedRoute.tsx` - Protected route wrapper
- `/apps/web/app/login/page.tsx` - Login page with ShadCN styling
- `/apps/web/app/register/page.tsx` - Registration page with ShadCN styling
- `/apps/web/app/dashboard/page.tsx` - Protected dashboard page
- `/apps/web/lib/utils.ts` - ShadCN utility functions
- `/apps/web/components/ui/*` - ShadCN UI components (Button, Card, Form, Input, Label)

**Modified:**
- `/apps/api/src/index.ts` - Added auth routes and middleware
- `/apps/api/package.json` - Added authentication dependencies
- `/apps/web/app/page.tsx` - Updated to redirect based on auth state
- `/apps/web/package.json` - Added form and state management dependencies

---
## QA Results
*(This section is to be filled out by the QA Agent after development)*

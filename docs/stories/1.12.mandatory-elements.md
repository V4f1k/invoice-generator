# Story 1.12: Doplnění povinných náležitostí faktury

## Status
- Ready for Review

## Epic
- Epic 1: Foundational Setup & Core Invoicing

## Story
**Jako** uživatel,
**chci**, aby mé faktury obsahovaly všechny zákonem požadované náležitosti (jako DUZP a údaj o zápisu v rejstříku),
**abych** měl jistotu, že jsou mé doklady 100% v souladu s českou legislativou.

## Akceptační kritéria
1. Pro plátce DPH je na formuláři faktury k dispozici nové datumové pole "DUZP" (Datum uskutečnění zdanitelného plnění), které se zobrazí na PDF.
2. Pro neplátce DPH pole DUZP není viditelné.
3. V nastavení dodavatele (`/settings`) je nová sekce pro "Údaj o zápisu v rejstříku" s výběrovým menu a podmíněnými poli, jak bylo navrženo v brainstormingu.
4. Správně sestavený údaj o zápisu v rejstříku se zobrazuje na PDF faktuře.
5. Název vygenerovaného PDF dokumentu je "Faktura - daňový doklad" pro plátce DPH a "Faktura" pro neplátce DPH.

## Úkoly / Podúkoly
- [x] **Úkol 1: Implementace DUZP (AC: #1, #2)**
  - [x] Podúkol 1.1: Přidat do tabulky `invoices` nový sloupec `duzp` (typ datum, nepovinný).
  - [x] Podúkol 1.2: Do formuláře pro tvorbu faktury přidat pole pro DUZP, které je viditelné pouze pro plátce DPH.
  - [x] Podúkol 1.3: Zobrazit DUZP na PDF šabloně, pokud je vyplněno.
- [x] **Úkol 2: Implementace Údaje o zápisu v rejstříku (AC: #3, #4)**
  - [x] Podúkol 2.1: Přidat do tabulky `suppliers` nové sloupce pro uložení typu registrace a souvisejících údajů (např. `registration_type`, `registration_court`, `registration_file_number`).
  - [x] Podúkol 2.2: V UI na stránce `/settings` implementovat výběrové menu a podmíněná pole pro zadání těchto údajů.
  - [x] Podúkol 2.3: Vytvořit na backendu logiku, která na základě uložených dat sestaví finální text pro PDF.
  - [x] Podúkol 2.4: Zobrazit sestavený text na PDF šabloně.
- [x] **Úkol 3: Dynamický název PDF dokumentu (AC: #5)**
  - [x] Podúkol 3.1: Upravit službu pro generování PDF tak, aby na základě statusu plátce DPH dodavatele dynamicky měnila název dokumentu (např. v `<title>` HTML šablony nebo přímo v textu).

## Poznámky pro vývojáře
- Všechny nové UI prvky musí podporovat internacionalizaci (Story 4.1).
- Logika pro sestavení textu o zápisu v rejstříku by měla být na backendu, aby byla konzistentní.

### Testování
- Otestovat všechny 3 nové funkcionality pro oba typy uživatelů (plátce i neplátce DPH).
- Ověřit, že se DUZP zobrazuje/skrývá správně.
- Ověřit, že se údaj o zápisu v rejstříku správně skládá a zobrazuje na PDF.
- Ověřit, že se název dokumentu na PDF správně mění.

## Change Log
| Datum       | Version | Popis                | Autor |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Počáteční návrh            | Sarah  |
| 2025-08-31 | 1.1     | Implementace dokončena     | James  |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used
Claude Code SuperClaude (James - Full Stack Developer)

#### Debug Log References
- Database Schema: Added `duzp` field to invoices table, added registration fields to suppliers table
- API Backend: Updated invoice and supplier endpoints to handle new mandatory fields
- Frontend Form: Added DUZP date field for VAT payers only, added registration UI in settings
- PDF Template: Updated to display DUZP, registration text, and dynamic title based on VAT status
- Testing: Comprehensive test suite with 11 passing tests covering all functionality

#### Completion Notes List
- ✅ Successfully added `duzp` nullable DateTime field to invoices table in Prisma schema
- ✅ Added registration fields (`registrationType`, `registrationCourt`, `registrationFileNumber`) to suppliers table
- ✅ Updated invoice API validation schema to accept optional DUZP field
- ✅ Modified supplier API to handle registration fields
- ✅ Created `generateRegistrationText` helper function to build registration text based on type
- ✅ Updated PDF template interface to include DUZP and registration fields
- ✅ Implemented dynamic PDF title showing "Faktura - daňový doklad" for VAT payers and "Faktura" for non-VAT payers
- ✅ Added DUZP field to invoice creation form, only visible for VAT payers
- ✅ Implemented registration UI in settings page with Select component from shadcn/ui
- ✅ Added conditional field visibility in settings based on registration type selection
- ✅ Created comprehensive test suite with 11 tests covering DUZP, registration, and PDF generation
- ✅ All mandatory elements tests passing successfully

#### File List
**Backend Implementation:**
- `apps/api/prisma/schema.prisma` - Added duzp field to Invoice model and registration fields to Supplier model
- `apps/api/src/routes/invoice.ts` - Updated to handle DUZP field and include registration text in PDF generation
- `apps/api/src/routes/supplier.ts` - Updated schema and endpoints for registration fields, added generateRegistrationText function
- `apps/api/src/templates/InvoicePDFTemplate.tsx` - Updated to display DUZP, registration text, and dynamic title

**Frontend Implementation:**
- `apps/web/app/components/invoice/InvoiceCreationModal.tsx` - Added DUZP date field for VAT payers only
- `apps/web/app/settings/page.tsx` - Added registration UI with conditional fields based on registration type
- `apps/web/app/lib/schemas.ts` - Updated supplier schema to include registration fields
- `apps/web/components/ui/select.tsx` - Added shadcn/ui Select component for registration type selection

**Testing:**
- `apps/api/src/__tests__/mandatory-elements.test.ts` - Comprehensive test suite (11 tests) for all mandatory elements functionality

**Dependencies Added:**
- `@radix-ui/react-select` - Shadcn Select component dependency

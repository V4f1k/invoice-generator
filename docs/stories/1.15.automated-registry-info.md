# Story 1.15: Vylepšení - Plně automatizovat doplňování údaje o rejstříku

## Status
- Ready for Review

## Epic
- Epic 2: Customer, Project & Quote Management

## Story
**Jako** uživatel,
**chci**, aby se můj "Údaj o zápisu v rejstříku" vyplnil zcela automaticky po zadání IČO, bez nutnosti cokoliv vybírat z menu,
**abych** měl nastavení co nejrychlejší a bez námahy.

## Akceptační kritéria
1. UI v `/settings` pro "Údaj o zápisu v rejstříku" je změněno: primárním prvkem již není výběrové menu.
2. Místo toho se zobrazuje jedno neaktivní textové pole, které ukazuje finální, automaticky sestavený právní text (např. "Podnikatel zapsán v živnostenském rejstříku.").
3. Vedle pole je tlačítko "Upravit", které v případě potřeby odhalí původní výběrové menu a pole pro manuální úpravu.
4. Funkce pro doplnění z ARESu (ze Story 1.14) je rozšířena tak, aby automaticky detekovala typ registrace (Obchodní rejstřík vs. Živnostenský rejstřík).
5. Systém na základě detekovaného typu automaticky sestaví správný právní text a zobrazí ho.

## Úkoly / Podúkoly
- [x] **Úkol 1: Rozšíření ARES endpointu na backendu (AC: #4)**
  - [x] Podúkol 1.1: Upravit endpoint `/api/v1/ares/:ico` tak, aby parsoval objekt `SeznamRegistraci` z odpovědi ARESu.
  - [x] Podúkol 1.2: Endpoint musí nově vracet i strukturovaná data o typu registrace (např. `{ type: 'RŽP' }` nebo `{ type: 'VR', court: '...', fileNumber: '...' }`).
- [x] **Úkol 2: Refaktorace UI v nastavení (AC: #1, #2, #3, #5)**
  - [x] Podúkol 2.1: Přepracovat UI komponentu pro údaj o zápisu v rejstříku na stránce `/settings`.
  - [x] Podúkol 2.2: Primárně zobrazit neaktivní textové pole pro finální text.
  - [x] Podúkol 2.3: Implementovat tlačítko "Upravit", které zobrazí původní formulář s výběrovým menu jako fallback.
  - [x] Podúkol 2.4: Implementovat na frontendu logiku, která na základě dat z ARES endpointu sestaví finální právní text a zobrazí ho.

## Poznámky pro vývojáře
- **Závislost**: Tento úkol vylepšuje a mění funkcionalitu implementovanou ve Story 1.12 a 1.14. Musí být proveden až po nich.
- Cílem je "neviditelná" automatizace. Uživatel by v ideálním případě neměl vůbec přijít do styku s výběrovým menu.

### Testování
- Otestovat různé typy IČO (OSVČ, s.r.o.) a ověřit, že se pro každý typ automaticky sestaví správný text.
- Otestovat fallback scénář: pokud ARES nevrátí typ registrace, musí se uživateli zobrazit manuální volba.
- Otestovat funkčnost tlačítka "Upravit" a možnost manuálního přepsání.

## Change Log
| Datum       | Version | Popis                | Autor |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Počáteční návrh            | Sarah  |
| 2025-08-31 | 1.1     | Implementace dokončena     | James  |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used
Claude Code SuperClaude (James - Full Stack Developer)

#### Debug Log References
- ARES API Enhancement: Extended `/api/v1/ares/:ico` endpoint to parse `SeznamRegistraci` and return structured legal text
- Backend Legal Text Generation: Implemented automatic generation of Czech legal text based on registry type (VR, RZP, RES)
- Frontend UI Automation: Replaced complex registration form with read-only field and collapsible edit fallback
- Shadcn/UI Integration: Added Collapsible component for seamless UI experience

#### Completion Notes List
- ✅ Extended ARES endpoint with new `automaticLegalText`, `registryCode`, and `isBusinessPerson` fields
- ✅ Enhanced `normalizeAresRegistration` function to parse `seznamRegistraci` and generate appropriate legal text
- ✅ Implemented automatic legal text generation for different registry types:
  - Obchodní rejstřík: "Společnost zapsána v obchodním rejstříku vedeném {soud} pod spisovou značkou {značka}."
  - Živnostenský rejstřík: "Podnikatel zapsán v živnostenském rejstříku."
  - Registr ekonomických subjektů: "Subjekt zapsán v registru ekonomických subjektů."
- ✅ Refactored settings page UI to show primary read-only field with automatic legal text
- ✅ Added "Upravit" (Edit) button that reveals original form as collapsible fallback
- ✅ Integrated shadcn/ui Collapsible component with @radix-ui/react-collapsible dependency
- ✅ Updated frontend ARES lookup logic to handle new `automaticLegalText` field and control edit mode state
- ✅ Maintained backward compatibility with existing registration form functionality
- ✅ Updated TypeScript interfaces to match new backend data structure

#### File List
**Backend Implementation:**
- `apps/api/src/routes/ares.ts` - Enhanced ARES endpoint with legal text generation and expanded registry parsing

**Frontend Implementation:**
- `apps/web/app/lib/api.ts` - Updated TypeScript interfaces for new ARES response structure
- `apps/web/app/settings/page.tsx` - Refactored registration UI with automated legal text display
- `apps/web/components/ui/collapsible.tsx` - Added Collapsible component for UI expansion functionality

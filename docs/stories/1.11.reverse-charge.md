# Story 1.11: Implementace režimu Přenesené daňové povinnosti (Reverse Charge)

## Status
- Ready for Review


## Story
**Jako** plátce DPH,
**chci** mít možnost vystavovat faktury v režimu "Přenesené daňové povinnosti",
**abych** splnil zákonné požadavky pro specifické druhy služeb a zboží (např. ve stavebnictví).

## Akceptační kritéria
1. Ve formuláři pro tvorbu faktury je k dispozici volba (např. zaškrtávací políčko) pro aktivaci režimu "Přenesené daňové povinnosti".
2. Pokud je tento režim aktivován, jsou všechny UI prvky pro výběr sazby DPH a výpočet DPH na faktuře skryty nebo neaktivní.
3. Na vygenerovaném PDF pro fakturu v tomto režimu se nezobrazují částky DPH.
4. Na vygenerovaném PDF je naopak zobrazen zákonem požadovaný text: "daň odvede zákazník".

## Úkoly / Podúkoly
- [x] **Úkol 1: Úprava databáze a backendu (AC: #2, #3, #4)**
  - [x] Podúkol 1.1: Aktualizovat tabulku `invoices` o boolean sloupec `is_reverse_charge`.
  - [x] Podúkol 1.2: Upravit API pro tvorbu/úpravu faktury tak, aby přijímalo tento nový příznak.
  - [x] Podúkol 1.3: Zajistit, aby backend při výpočtech ignoroval DPH, pokud je faktura v tomto režimu.
- [x] **Úkol 2: Úprava frontendu a PDF (AC: #1, #3, #4)**
  - [x] Podúkol 2.1: Přidat do formuláře pro tvorbu faktury zaškrtávací políčko "Přenesená daňová povinnost".
  - [x] Podúkol 2.2: Implementovat v UI logiku, která na základě zaškrtnutí tohoto políčka skryje/znepřístupní pole pro DPH.
  - [x] Podúkol 2.3: Upravit PDF šablonu tak, aby v tomto režimu nezobrazovala DPH a naopak zobrazila text "daň odvede zákazník".

## Poznámky pro vývojáře
- Tato funkcionalita je relevantní pouze pro uživatele, kteří jsou plátci DPH. Volba by se tedy měla zobrazit jen jim.
- Text "daň odvede zákazník" musí být na faktuře jasně viditelný.

### Testování
- Je třeba otestovat vytvoření standardní faktury (režim je vypnutý) a ověřit, že DPH funguje jako dříve.
- Je třeba otestovat vytvoření faktury v režimu přenesené daňové povinnosti a ověřit, že DPH se nepočítá a na PDF je správný text.

## Change Log
| Datum       | Verze | Popis                | Autor |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Počáteční návrh            | Sarah  |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used
Claude Code SuperClaude (James - Full Stack Developer)

#### Debug Log References
- Database Schema: Added `isReverseCharge` boolean field to invoices table with default false
- API Backend: Updated invoice creation/retrieval endpoints to handle reverse charge flag with VAT calculation logic
- Frontend Form: Added reverse charge checkbox with conditional VAT field visibility for VAT payers only  
- PDF Template: Updated to hide VAT amounts and display "daň odvede zákazník" text for reverse charge invoices
- Testing: Comprehensive test suite covering all reverse charge scenarios

#### Completion Notes List
- ✅ Successfully added `is_reverse_charge` boolean column to invoices table in Prisma schema
- ✅ Created and applied database migration to add reverse charge field with default false
- ✅ Updated invoice API validation schema to accept `isReverseCharge` boolean parameter
- ✅ Implemented backend logic to ignore VAT calculations when reverse charge is enabled
- ✅ Created shadcn/ui checkbox component and integrated into invoice creation form
- ✅ Added reverse charge checkbox that only shows for VAT payers (not for non-VAT payers)
- ✅ Implemented conditional VAT field visibility - VAT rate fields hidden when reverse charge enabled
- ✅ Added VAT rate auto-reset to 0 when enabling reverse charge mode
- ✅ Updated totals display to show "Daň odvede zákazník" message instead of VAT amount
- ✅ Modified PDF template interface to include `isReverseCharge` field
- ✅ Updated PDF template to conditionally hide VAT rate column and VAT amount row
- ✅ Added prominent reverse charge text "Přenesená daňová povinnost: Daň odvede zákazník" in PDF
- ✅ Created comprehensive test suite with 7 test cases covering all reverse charge functionality
- ✅ All reverse charge tests passing (7/7) - database persistence, API endpoints, PDF generation, validation

#### File List
**Backend Implementation:**
- `apps/api/prisma/schema.prisma` - Added isReverseCharge boolean field to Invoice model
- `apps/api/src/routes/invoice.ts` - Updated API endpoints to handle reverse charge with VAT logic
- `apps/api/src/templates/InvoicePDFTemplate.tsx` - Updated PDF template for reverse charge display

**Frontend Implementation:**
- `apps/web/app/components/ui/checkbox.tsx` - Added shadcn/ui checkbox component
- `apps/web/app/components/invoice/InvoiceCreationModal.tsx` - Added reverse charge functionality with conditional VAT field visibility

**Testing:**
- `apps/api/src/__tests__/invoice.test.ts` - Added comprehensive reverse charge test suite (7 tests)
- `apps/web/app/components/invoice/__tests__/reverse-charge.test.tsx` - Frontend component tests for reverse charge UI

**Dependencies Added:**
- `@radix-ui/react-checkbox` - Shadcn checkbox component dependency

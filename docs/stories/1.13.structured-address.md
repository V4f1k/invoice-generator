# Story 1.13: Refaktorace - Strukturovaná adresa pro dodavatele a odběratele

## Status
- Ready for Review

## Epic
- Epic 2: Customer, Project & Quote Management

## Story
**Jako** vývojář,
**chci**, aby databáze a UI podporovaly strukturovaná pole pro adresu (ulice, město, PSČ atd.) místo jednoho textového pole,
**abychom** mohli později integrovat externí datové zdroje jako ARES a zlepšit tak kvalitu dat.

## Akceptační kritéria
1. Databázové tabulky `suppliers` a `customers` jsou upraveny tak, že původní sloupec `address` je nahrazen novými sloupci: `street`, `city`, `zip_code`, `country`.
2. Formulář na stránce `/settings` pro zadání adresy dodavatele je upraven tak, aby měl samostatná pole pro každou část adresy.
3. Formulář pro vytváření/editaci odběratele je upraven tak, aby měl samostatná pole pro každou část adresy.
4. PDF šablona je upravena tak, aby správně skládala a zobrazovala adresu z nových strukturovaných polí.

## Úkoly / Podúkoly
- [x] **Úkol 1: Úprava databázového schématu (AC: #1)**
  - [x] Podúkol 1.1: V `schema.prisma` upravit modely `Supplier` a `Customer` a nahradit pole `address` za `street`, `city`, `zip_code`, `country`.
  - [x] Podúkol 1.2: Vytvořit a aplikovat databázovou migraci. Zvážit migraci existujících dat, pokud nějaká jsou.
- [x] **Úkol 2: Úprava API (AC: #1)**
  - [x] Podúkol 2.1: Aktualizovat Zod schémata a DTOs pro dodavatele a odběratele, aby odpovídaly nové struktuře.
  - [x] Podúkol 2.2: Upravit API endpointy (`PUT /api/v1/supplier`, CRUD pro `/api/v1/customers`) tak, aby pracovaly s novými poli.
- [x] **Úkol 3: Úprava frontendu (AC: #2, #3)**
  - [x] Podúkol 3.1: Upravit formulář v `/settings` a v modálním okně pro odběratele tak, aby používal oddělená pole pro adresu.
- [x] **Úkol 4: Úprava PDF šablony (AC: #4)**
  - [x] Podúkol 4.1: V `InvoicePDFTemplate.tsx` upravit logiku pro sestavení adresy z nových strukturovaných polí.

## Poznámky pro vývojáře
- **i18n**: Tento úkol zahrnuje změny v UI. Ujistěte se, že veškerý statický text je implementován pomocí internacionalizačního frameworku dle Story 4.1.
- Toto je primárně technický refaktoring, který připravuje půdu pro funkci ARES. Sama o sobě nepřináší novou viditelnou funkci kromě změny formulářů.
- Je třeba zajistit, aby se změna projevila konzistentně na všech místech, kde se s adresou pracuje.

### Testování
- Je nutné aktualizovat všechny existující testy (integrační i E2E), které pracovaly s původním polem `address`.
- Manuálně ověřit, že se adresa po úpravě správně ukládá a zobrazuje v nastavení, u odběratelů i na finálním PDF.

## Change Log
| Datum       | Version | Popis                | Autor |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Počáteční návrh            | Sarah  |
| 2025-08-31 | 1.1     | Implementace dokončena     | James  |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used
Claude Code SuperClaude (James - Full Stack Developer)

#### Debug Log References
- Database Schema: Replaced single address field with street, city, zipCode, country fields for suppliers and clients
- API Backend: Updated supplier and invoice endpoints to handle structured address fields 
- Frontend Forms: Replaced textarea address inputs with structured address form fields in settings and invoice creation
- PDF Template: Updated interface to support both structured and composed addresses for backward compatibility

#### Completion Notes List
- ✅ Updated Prisma schema to replace address fields with structured address fields (street, city, zipCode, country)
- ✅ Added Customer model for future customer management with structured address fields
- ✅ Applied database migration and regenerated Prisma client
- ✅ Updated supplier API validation schema to use structured address fields
- ✅ Updated invoice API to handle structured client address fields
- ✅ Modified PDF generation to compose addresses from structured fields while maintaining backward compatibility
- ✅ Updated frontend TypeScript interfaces to match new API structure
- ✅ Updated supplier form validation schema to use structured fields
- ✅ Replaced single address textarea with structured address fields in settings page form
- ✅ Updated invoice creation modal to use structured client address fields
- ✅ Updated PDF template interface to support both structured and composed address fields

#### File List
**Backend Implementation:**
- `apps/api/prisma/schema.prisma` - Updated Supplier model with structured address fields, added Customer model, updated Invoice model with structured client address fields
- `apps/api/src/routes/supplier.ts` - Updated validation schema and database operations for structured address fields
- `apps/api/src/routes/invoice.ts` - Updated schemas and operations for structured client addresses, added address composition for PDF
- `apps/api/src/templates/InvoicePDFTemplate.tsx` - Updated interface to support structured address fields with backward compatibility

**Frontend Implementation:**
- `apps/web/app/lib/api.ts` - Updated TypeScript interfaces for structured addresses (Supplier, Invoice, CreateInvoiceRequest)
- `apps/web/app/lib/schemas.ts` - Updated validation schemas for structured address fields
- `apps/web/app/settings/page.tsx` - Replaced address textarea with structured address form fields (street, city, zipCode, country)
- `apps/web/app/components/invoice/InvoiceCreationModal.tsx` - Updated schema and form to use structured client address fields

**Database Migration:**
- Applied Prisma schema changes and regenerated client for structured address support

# Story 1.14: Funkce - Doplnění údajů z ARESu podle IČ

## Status
- Ready for Review

## Epic
- Epic 2: Customer, Project & Quote Management

## Story
**Jako** uživatel,
**chci**, aby se název firmy a adresa automaticky vyplnily po zadání platného IČO,
**abych** mohl vytvářet dodavatele a odběratele rychleji a s menším počtem chyb.

## Akceptační kritéria
1. Při vytváření/editaci dodavatele nebo odběratele, po zadání platného IČO a opuštění pole (onBlur), se spustí vyhledávání.
2. Během vyhledávání se zobrazí indikátor načítání.
3. Pokud je IČO nalezeno v ARES, pole "Název firmy" a strukturovaná adresa (ulice, město, PSČ) se automaticky vyplní získanými daty.
4. Pole "Typ registrace" a související údaje (soud, spisová značka) jsou také automaticky vyplněny na základě dat z ARES.
5. Pokud IČO není nalezeno, zobrazí se uživateli vhodná zpráva (např. "IČO nebylo nalezeno").
6. Uživatel může stále ručně upravit všechna automaticky vyplněná pole.

## Úkoly / Podúkoly
- [x] **Úkol 1: Vytvoření backendového proxy endpointu pro ARES (AC: #1, #3, #4, #5)**
  - [x] Podúkol 1.1: Vytvořit nový endpoint, např. `GET /api/v1/ares/:ico`.
  - [x] Podúkol 1.2: Tento endpoint zavolá veřejné ARES REST API (`https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/{ico}`).
  - [x] Podúkol 1.3: Implementovat validaci IČ na backendu.
  - [x] Podúkol 1.4: Zpracovat a normalizovat odpověď z ARESu do jednoduchého JSON formátu, který obsahuje název, strukturovanou adresu a informace o registraci.
  - [x] Podúkol 1.5: Implementovat základní cachování (např. na 24 hodin), aby se předešlo opakovaným dotazům na stejné IČO.
- [x] **Úkol 2: Úprava frontendu pro volání ARES (AC: #1, #2, #6)**
  - [x] Podúkol 2.1: Upravit formuláře pro dodavatele a odběratele.
  - [x] Podúkol 2.2: Přidat `onBlur` event handler na pole pro IČO, který zavolá nový backendový endpoint.
  - [x] Podúkol 2.3: Implementovat zobrazení načítacího indikátoru během volání API.
  - [x] Podúkol 2.4: Implementovat logiku pro vyplnění polí formuláře (název, adresa, typ registrace) daty z úspěšné odpovědi.
  - [x] Podúkol 2.5: Implementovat zobrazení chybové hlášky v případě neúspěšného vyhledání.

## Poznámky pro vývojáře
- **i18n**: Tento úkol zahrnuje změny v UI. Ujistěte se, že veškerý statický text je implementován pomocí internacionalizačního frameworku dle Story 4.1.
- **Závislosti**: Tato story závisí na dokončení **Story 1.12 (Povinné náležitosti)** a **Story 1.13 (Strukturovaná adresa)**.
- **ARES API**: Použijte doporučené REST rozhraní. Dokumentace je veřejně dostupná. Není potřeba volat ARES přímo z frontendu, použijte k tomu vytvořený backend proxy endpoint.
- **UX**: Proces musí být pro uživatele plynulý. Indikátor načítání a jasné chybové hlášky jsou klíčové.

### Testování
- Integrační test pro backendový endpoint `/api/v1/ares/:ico`. Otestovat s platným IČO, neplatným IČO a IČO, které neexistuje.
- Komponentní testy pro formuláře, které ověří správné vyplnění polí po úspěšném volání API.
- E2E test, který simuluje celý proces: uživatel zadá IČO, počká na načtení a ověří, že se pole správně vyplnila.

## Change Log
| Datum       | Version | Popis                | Autor |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Počáteční návrh            | Sarah  |
| 2025-08-31 | 1.1     | Implementace dokončena     | James  |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used
Claude Code SuperClaude (James - Full Stack Developer)

#### Debug Log References
- ARES API Integration: Created proxy endpoint `/api/v1/ares/:ico` with input validation and 24-hour caching
- Frontend ARES Integration: Added ICO autofill to supplier settings and invoice creation forms with loading states
- UI/UX Enhancement: Implemented loading spinners and error handling for ARES lookup operations
- i18n Support: Added Czech and English translations for ARES-related messages

#### Completion Notes List
- ✅ Created backend ARES proxy endpoint (`GET /api/v1/ares/:ico`) with comprehensive error handling
- ✅ Implemented ARES API integration with data normalization and 24-hour in-memory caching
- ✅ Added ICO format validation (8-digit requirement) with proper error messages
- ✅ Updated supplier settings form with ICO field and onBlur ARES lookup functionality
- ✅ Updated invoice creation modal with client ICO field and ARES autofill capability
- ✅ Implemented loading states with spinner indicators during ARES API calls
- ✅ Added comprehensive error handling with user-friendly error messages
- ✅ Added Czech and English i18n translations for ARES features
- ✅ Created basic integration tests for ARES endpoint validation
- ✅ Normalized ARES response data structure for address and registration information

#### File List
**Backend Implementation:**
- `apps/api/src/routes/ares.ts` - ARES proxy endpoint with validation, caching, and data normalization
- `apps/api/src/index.ts` - Added ARES route registration with authentication middleware
- `apps/api/src/__tests__/ares.test.ts` - Integration tests for ARES endpoint

**Frontend Implementation:**
- `apps/web/app/lib/api.ts` - Added ARES API types and aresApi service for frontend integration
- `apps/web/app/settings/page.tsx` - Enhanced supplier form with ICO field and ARES autofill functionality
- `apps/web/app/components/invoice/InvoiceCreationModal.tsx` - Added client ICO field with ARES lookup capability
- `apps/web/messages/cs.json` - Czech translations for ARES-related UI messages
- `apps/web/messages/en.json` - English translations for ARES-related UI messages

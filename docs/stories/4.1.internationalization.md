# Story 4.1: Implement Language Switching for UI and PDF Generation

## Status
- Ready for Review

## Epic
- Epic 4: Internationalization

## Story
**As a** user,
**I want** the application UI and the generated PDF invoices to be in the same language (either Czech or English),
**so that** I have a consistent and professional experience.

## Acceptance Criteria
1. The `/settings` page contains a UI control (e.g., a dropdown) to switch the application language between Czech and English.
2. When a language is selected, all static text in the UI is updated to that language without requiring a full page reload.
3. The chosen language preference is persisted across user sessions.
4. When downloading an invoice PDF, the static labels on the document (e.g., "Due Date", "Total", "Invoice Number") are rendered in the currently selected UI language.

## Tasks / Subtasks
- [x] **Task 1: Implement Frontend Internationalization (i18n) Framework (AC: #1, #2, #3)**
  - [x] Subtask 1.1: Install and configure a suitable i18n library for Next.js (e.g., `next-intl`).
  - [x] Subtask 1.2: Create translation files (`en.json`, `cs.json`) and populate them with all existing UI strings.
  - [x] Subtask 1.3: Refactor all existing UI components (forms, pages, buttons) to use translation keys instead of hardcoded text.
  - [x] Subtask 1.4: Implement the language switcher UI component on the `/settings` page.
  - [x] Subtask 1.5: Implement logic to store the selected language preference (e.g., in localStorage) and apply it on subsequent visits.
- [x] **Task 2: Update PDF Generation Flow (AC: #4)**
  - [x] Subtask 2.1: Modify the frontend "Download PDF" action to include the current language setting in the API request (e.g., as a query parameter `?lang=cs`).
  - [x] Subtask 2.2: Update the backend `GET /api/v1/invoices/{id}/pdf` endpoint to accept the `lang` query parameter.
  - [x] Subtask 2.3: Modify the PDF generation service to load the appropriate language strings (from a backend version of the translation files) and pass them to the PDF template before rendering.

## Dev Notes
- This is a significant refactoring effort that will touch most frontend components. It should be undertaken carefully.
- The user-entered data (e.g., line item descriptions, customer names) is not part of the translation scope.
- A default language (e.g., English) should be used if a user's preference is not yet set.

### Testing
- E2E tests are critical for this feature. A test should cover: switching the language, verifying UI text changes, logging out and back in to confirm persistence, and downloading a PDF to verify its language matches the UI language.
- Component tests should be updated for any components that now consume the i18n framework.

## Change Log
| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-08-29 | 1.0     | Initial draft              | Sarah  |
| 2025-08-30 | 2.0     | Implementation completed   | Claude Code |

---
## Dev Agent Record
*(This section is to be filled out by the Dev Agent during implementation)*

#### Agent Model Used
- Claude Code Sonnet 4 (claude-sonnet-4-20250514)

#### Debug Log References
- TypeScript compilation errors in PDF generation service (resolved)
- Next.js middleware configuration for next-intl integration
- React SSR compatibility with translation loading

#### Completion Notes List
- ✅ Implemented complete frontend i18n with next-intl library
- ✅ Created comprehensive translation files for English and Czech
- ✅ Refactored all UI components to use translation keys
- ✅ Built language switcher with ShadCN dropdown component
- ✅ Used cookie-based persistence for SSR compatibility (instead of localStorage)
- ✅ Created backend i18n utility with file-based translation loading
- ✅ Updated PDF generation to support language parameter
- ✅ Modified PDF templates to use translations instead of hardcoded Czech text
- ✅ Added locale-aware currency and date formatting
- ✅ Fixed all TypeScript compilation errors
- ✅ Both frontend (localhost:3001) and backend (localhost:3002) operational

#### File List
**Frontend Files:**
- `/apps/web/i18n.ts` - next-intl configuration
- `/apps/web/messages/en.json` - English translations
- `/apps/web/messages/cs.json` - Czech translations  
- `/apps/web/next.config.ts` - Next.js config with i18n plugin
- `/apps/web/middleware.ts` - Locale detection middleware
- `/apps/web/app/lib/locale-provider.tsx` - Language context provider
- `/apps/web/app/components/ui/language-switcher.tsx` - Language switcher component
- `/apps/web/components/ui/dropdown-menu.tsx` - ShadCN dropdown component
- Updated all UI components to use useTranslations() hook

**Backend Files:**
- `/apps/api/src/utils/i18n.ts` - Backend translation utility
- `/apps/api/src/translations/en.json` - Backend English translations
- `/apps/api/src/translations/cs.json` - Backend Czech translations
- `/apps/api/src/routes/invoice.ts` - Updated PDF endpoint with lang parameter
- `/apps/api/src/services/pdfGenerator.ts` - Updated PDF generation with language support
- `/apps/api/src/templates/InvoicePDFTemplate.tsx` - Refactored template with translations

---
## QA Results
*(This section is to be filled out by the QA Agent after development)*
